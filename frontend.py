import streamlit as st
import requests
import json
import uuid
from typing import List, Dict, Optional

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="CRINGE - Personagens Interativos",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Configura√ß√µes da API
API_URL = "https://cringe-5jmi.onrender.com"

# Inicializa√ß√£o do session_state
if 'current_page' not in st.session_state:
    st.session_state.current_page = "home"
if 'current_bot' not in st.session_state:
    st.session_state.current_bot = None
if 'conversations' not in st.session_state:
    st.session_state.conversations = {}
if 'widget_counter' not in st.session_state:
    st.session_state.widget_counter = 0

def get_unique_key(prefix="widget"):
    """Gera uma chave √∫nica para widgets"""
    st.session_state.widget_counter += 1
    return f"{prefix}_{st.session_state.widget_counter}"

# Fun√ß√µes da API
def load_bots_from_db() -> List[Dict]:
    """Carrega bots do banco de dados"""
    try:
        response = requests.get(f"{API_URL}/bots")
        if response.status_code == 200:
            return response.json()
        else:
            st.error(f"Erro ao carregar bots: {response.status_code}")
            return []
    except Exception as e:
        st.error(f"Erro de conex√£o: {str(e)}")
        return []

def delete_bot(bot_id: str):
    """Exclui um bot"""
    try:
        response = requests.delete(f"{API_URL}/bots/{bot_id}")
        if response.status_code == 200:
            st.success("‚úÖ Bot exclu√≠do com sucesso!")
            st.rerun()
        else:
            error_msg = response.json().get('error', 'Erro desconhecido')
            st.error(f"‚ùå Erro ao excluir bot: {error_msg}")
    except Exception as e:
        st.error(f"‚ùå Erro ao conectar com o servidor: {str(e)}")

def chat_with_bot(bot_id: str, message: str, conversation_id: Optional[str] = None):
    """Envia mensagem para um bot"""
    try:
        payload = {
            "message": message,
            "conversation_id": conversation_id
        }
        response = requests.post(f"{API_URL}/bots/chat/{bot_id}", json=payload, timeout=30)
        if response.status_code == 200:
            return response.json()
        else:
            st.error(f"Erro ao enviar mensagem: {response.status_code}")
            return None
    except Exception as e:
        st.error(f"Erro de conex√£o: {str(e)}")
        return None

def import_bots(bots_data: Dict):
    """Importa bots via JSON"""
    try:
        response = requests.post(f"{API_URL}/bots/import", json=bots_data, timeout=30)
        
        if response.status_code == 200:
            return True, response.json().get('message', 'Importa√ß√£o realizada com sucesso!')
        else:
            error_detail = response.json().get('detail', 'Erro desconhecido')
            return False, f"Erro: {error_detail}"
    except Exception as e:
        return False, f"Erro de conex√£o: {str(e)}"

# Componentes da UI
def show_chat_interface():
    """Interface de chat com o bot - CORRIGIDA"""
    if not st.session_state.current_bot:
        st.error("‚ùå Nenhum bot selecionado para conversar")
        if st.button("üè† Voltar para In√≠cio", key=get_unique_key("back_from_no_bot")):
            st.session_state.current_page = "home"
            st.rerun()
        return
    
    bot = st.session_state.current_bot
    
    # Header do chat
    col1, col2, col3 = st.columns([3, 1, 1])
    with col1:
        st.title(f"üí¨ {bot['name']}")
    with col2:
        if st.button("üè† In√≠cio", key=get_unique_key("back_home"), use_container_width=True):
            st.session_state.current_page = "home"
            st.rerun()
    with col3:
        if st.button("ü§ñ Personagens", key=get_unique_key("back_bots"), use_container_width=True):
            st.session_state.current_page = "bots"
            st.rerun()
    
    st.markdown(f"*{bot['introduction']}*")
    st.markdown("---")
    
    # Inicializar conversa se necess√°rio
    if bot['id'] not in st.session_state.conversations:
        st.session_state.conversations[bot['id']] = {
            'conversation_id': None,
            'messages': []
        }
    
    # Exibir mensagem de boas-vindas se n√£o houver mensagens
    current_conversation = st.session_state.conversations[bot['id']]
    if not current_conversation['messages']:
        with st.chat_message("assistant"):
            st.write(bot['welcome_message'])
        current_conversation['messages'].append({
            'content': bot['welcome_message'],
            'is_user': False
        })
    
    # Exibir hist√≥rico de mensagens
    for msg in current_conversation['messages']:
        if msg['is_user']:
            with st.chat_message("user"):
                st.write(msg['content'])
        else:
            with st.chat_message("assistant"):
                st.write(msg['content'])
    
    # Input de mensagem usando st.chat_input (mais moderno)
    user_message = st.chat_input("Digite sua mensagem...", key=get_unique_key("chat_input"))
    
    if user_message and user_message.strip():
        # Adicionar mensagem do usu√°rio ao hist√≥rico
        current_conversation['messages'].append({
            'content': user_message,
            'is_user': True
        })
        
        # Obter resposta do bot
        with st.spinner(f"{bot['name']} est√° pensando..."):
            response = chat_with_bot(
                bot['id'], 
                user_message, 
                current_conversation['conversation_id']
            )
            
            if response:
                # Atualizar conversation_id
                current_conversation['conversation_id'] = response['conversation_id']
                
                # Adicionar resposta do bot
                current_conversation['messages'].append({
                    'content': response['response'],
                    'is_user': False
                })
                
                st.rerun()

def show_bots_list():
    """P√°gina de listagem de bots"""
    st.title("ü§ñ Meus Personagens")
    st.markdown("---")
    
    # Carregar bots
    bots = load_bots_from_db()
    
    if not bots:
        st.info("""
        üé≠ **Nenhum personagem encontrado!**
        
        Os personagens padr√£o devem ser carregados automaticamente.
        Se voc√™ est√° vendo esta mensagem, verifique se o backend est√° funcionando.
        """)
        
        # Bot√£o para verificar status
        if st.button("üîÑ Verificar Status do Sistema", key=get_unique_key("check_status")):
            try:
                health = requests.get(f"{API_URL}/health")
                if health.status_code == 200:
                    health_data = health.json()
                    st.success(f"‚úÖ API Online - {health_data.get('statistics', {}).get('bots', 0)} bots no sistema")
                else:
                    st.error(f"‚ùå API com problemas: {health.status_code}")
            except Exception as e:
                st.error(f"üí• Erro de conex√£o: {e}")
        return
    
    # Lista de bots
    for i, bot in enumerate(bots):
        with st.container():
            col1, col2, col3 = st.columns([3, 1, 1])
            
            with col1:
                # Avatar e informa√ß√µes b√°sicas
                col_avatar, col_info = st.columns([1, 4])
                with col_avatar:
                    st.image(bot['avatar_url'], width=80)
                with col_info:
                    st.subheader(bot['name'])
                    st.write(f"*{bot['introduction']}*")
                    st.caption(f"**Personalidade:** {bot['personality']}")
                    
                    # Tags
                    if bot['tags']:
                        tags_text = " ".join([f"`{tag}`" for tag in bot['tags']])
                        st.caption(f"**Tags:** {tags_text}")
            
            with col2:
                if st.button("üí¨ Conversar", key=f"chat_{bot['id']}_{i}", use_container_width=True):
                    st.session_state.current_bot = bot
                    st.session_state.current_page = "chat"
                    st.rerun()
            
            with col3:
                # N√£o permitir excluir bots do sistema
                if bot.get('creator_id') != 'system':
                    if st.button("üóëÔ∏è Excluir", key=f"delete_{bot['id']}_{i}", use_container_width=True, type="secondary"):
                        if st.button(f"‚úÖ Confirmar exclus√£o de {bot['name']}", key=f"confirm_delete_{bot['id']}"):
                            delete_bot(bot['id'])
                else:
                    st.caption("üîí Bot do sistema")
            
            st.markdown("---")

def show_import_page():
    """P√°gina de importa√ß√£o de bots"""
    st.title("üì• Importar Personagens")
    st.markdown("---")
    
    # Status da API
    try:
        health = requests.get(f"{API_URL}/health")
        if health.status_code == 200:
            health_data = health.json()
            st.success(f"‚úÖ API Online - {health_data.get('statistics', {}).get('bots', 0)} bots no sistema")
        else:
            st.error(f"‚ùå API com problemas: {health.status_code}")
    except Exception as e:
        st.error(f"üí• Erro de conex√£o: {e}")
    
    st.markdown("---")
    
    # √Årea para colar JSON manualmente
    st.subheader("üìù Cole o JSON aqui")
    json_input = st.text_area(
        "Cole o conte√∫do JSON dos personagens:",
        height=300,
        key=get_unique_key("json_input"),
        placeholder='{"bots": [{"creator_id": "user", "name": "Nome", ...}]}'
    )
    
    # JSON de exemplo
    json_exemplo = '''{
  "bots": [
    {
      "creator_id": "user",
      "name": "Meu Personagem",
      "gender": "Feminino",
      "introduction": "Um personagem personalizado",
      "personality": "Amig√°vel e curioso",
      "welcome_message": "Ol√°! Sou seu novo personagem! üëã",
      "avatar_url": "https://i.imgur.com/07kI9Qh.jpeg",
      "tags": ["personalizado", "amig√°vel"],
      "conversation_context": "Contexto personalizado",
      "context_images": "[]",
      "system_prompt": "Voc√™ √© um personagem personalizado criado pelo usu√°rio.",
      "ai_config": {
        "temperature": 0.7,
        "max_output_tokens": 500
      }
    }
  ]
}'''
    
    # Bot√£o para usar exemplo
    if st.button("üìã Usar Exemplo", key=get_unique_key("use_example")):
        st.session_state[get_unique_key("json_input")] = json_exemplo
        st.rerun()
    
    # Bot√£o de importa√ß√£o
    if st.button("üöÄ IMPORTAR PERSONAGENS", type="primary", key=get_unique_key("import_button")):
        if json_input.strip():
            try:
                bots_data = json.loads(json_input)
                
                # Validar estrutura
                if "bots" not in bots_data:
                    st.error("‚ùå Estrutura inv√°lida: falta a chave 'bots'")
                elif not isinstance(bots_data["bots"], list):
                    st.error("‚ùå Estrutura inv√°lida: 'bots' deve ser uma lista")
                elif len(bots_data["bots"]) == 0:
                    st.error("‚ùå Nenhum personagem encontrado no JSON")
                else:
                    st.info(f"üìã Encontrados {len(bots_data['bots'])} personagem(s)")
                    
                    # Mostrar preview
                    with st.expander("üëÄ Visualizar Personagens"):
                        for i, bot in enumerate(bots_data["bots"][:3]):
                            st.write(f"**{i+1}. {bot.get('name', 'Sem nome')}**")
                            st.write(f"   {bot.get('introduction', 'Sem descri√ß√£o')}")
                    
                    # Importar
                    with st.spinner("Importando personagens..."):
                        success, message = import_bots(bots_data)
                        
                    if success:
                        st.success(f"üéâ {message}")
                        st.balloons()
                        st.info("‚úÖ Importa√ß√£o conclu√≠da! Verifique a lista de personagens.")
                    else:
                        st.error(f"‚ùå {message}")
                        
            except json.JSONDecodeError as e:
                st.error(f"‚ùå Erro no JSON: {str(e)}")
            except Exception as e:
                st.error(f"‚ùå Erro inesperado: {str(e)}")
        else:
            st.warning("‚ö†Ô∏è Cole o JSON no campo acima")
    
    st.markdown("---")
    
    # Informa√ß√£o sobre bots do sistema
    st.info("""
    **üí° Informa√ß√£o:** 
    - Os 4 personagens padr√£o (Pimenta, Zimbrak, Luma, Tiko) j√° est√£o pr√©-carregados no sistema
    - Use esta p√°gina para importar personagens adicionais ou personalizados
    - Bots do sistema n√£o podem ser exclu√≠dos
    """)

def show_home_page():
    """P√°gina inicial"""
    st.title("üé≠ CRINGE - Personagens Interativos")
    st.markdown("---")
    
    # Carregar bots
    bots = load_bots_from_db()
    
    # Cards de estat√≠sticas
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("Personagens Cadastrados", len(bots))
    
    with col2:
        active_conversations = len([conv for conv in st.session_state.conversations.values() if conv['messages']])
        st.metric("Conversas Ativas", active_conversations)
    
    with col3:
        total_messages = sum(len(conv['messages']) for conv in st.session_state.conversations.values())
        st.metric("Mensagens Trocadas", total_messages)
    
    st.markdown("---")
    
    # Bot√µes de a√ß√£o principais
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ü§ñ Ver Personagens", key=get_unique_key("view_bots"), use_container_width=True):
            st.session_state.current_page = "bots"
            st.rerun()
    
    with col2:
        if st.button("üì• Importar", key=get_unique_key("import_home"), use_container_width=True):
            st.session_state.current_page = "import"
            st.rerun()
    
    st.markdown("---")
    
    # Personagens dispon√≠veis
    if bots:
        st.subheader("üöÄ Personagens Dispon√≠veis")
        
        # Mostrar bots em cards
        cols = st.columns(min(3, len(bots)))
        for idx, bot in enumerate(bots[:3]):
            with cols[idx]:
                with st.container():
                    st.image(bot['avatar_url'], use_column_width=True)
                    st.subheader(bot['name'])
                    st.write(bot['introduction'])
                    if st.button(f"üí¨ Conversar com {bot['name']}", key=f"home_chat_{bot['id']}_{idx}"):
                        st.session_state.current_bot = bot
                        st.session_state.current_page = "chat"
                        st.rerun()
        
        if len(bots) > 3:
            if st.button("üìã Ver Todos os Personagens ‚Üí", key=get_unique_key("view_all_bots")):
                st.session_state.current_page = "bots"
                st.rerun()
    else:
        # Mensagem quando n√£o h√° bots
        st.info("""
        ## üéâ Bem-vindo ao CRINGE!
        
        **Personagens Interativos com Personalidades √önicas**
        
        Para come√ßar, verifique se o sistema est√° carregado corretamente.
        Os personagens padr√£o devem aparecer automaticamente.
        
        *Personagens inclu√≠dos: Pimenta, Zimbrak, Luma e Tiko!*
        """)

# Barra lateral de navega√ß√£o
with st.sidebar:
    st.title("üé≠ CRINGE")
    st.markdown("---")
    
    # Navega√ß√£o
    page_options = {
        "üè† In√≠cio": "home",
        "ü§ñ Personagens": "bots", 
        "üì• Importar": "import"
    }
    
    for page_name, page_id in page_options.items():
        if st.button(page_name, 
                    key=f"nav_{page_id}",
                    use_container_width=True, 
                    type="primary" if st.session_state.current_page == page_id else "secondary"):
            st.session_state.current_page = page_id
            st.rerun()
    
    st.markdown("---")
    
    # Se estiver em uma conversa, mostrar bot√£o para voltar ao chat
    if st.session_state.current_page == "chat" and st.session_state.current_bot:
        if st.button("üí¨ Voltar ao Chat", key=get_unique_key("back_to_chat"), use_container_width=True):
            st.session_state.current_page = "chat"
            st.rerun()
    
    st.markdown("---")
    
    # Informa√ß√µes do sistema
    st.subheader("üîç Status do Sistema")
    try:
        health_response = requests.get(f"{API_URL}/health", timeout=10)
        if health_response.status_code == 200:
            health_data = health_response.json()
            st.success("‚úÖ API Online")
            
            # Mostrar estat√≠sticas
            stats = health_data.get('statistics', {})
            st.caption(f"**Bots:** {stats.get('bots', 0)}")
            st.caption(f"**Conversas:** {stats.get('conversations', 0)}")
            st.caption(f"**Mensagens:** {stats.get('messages', 0)}")
            
        else:
            st.error(f"‚ùå API Offline - Status {health_response.status_code}")
    except Exception as e:
        st.error(f"‚ùå Erro de conex√£o: {str(e)}")
    
    st.markdown("---")
    
    # Bot√£o de limpar conversas locais
    if st.button("üóëÔ∏è Limpar Conversas Locais", key=get_unique_key("clear_local_chats")):
        st.session_state.conversations = {}
        st.success("‚úÖ Conversas locais limpas!")
        st.rerun()
    
    # Debug info
    with st.expander("üîß Debug Info"):
        st.write(f"P√°gina atual: {st.session_state.current_page}")
        st.write(f"Bot atual: {st.session_state.current_bot['name'] if st.session_state.current_bot else 'Nenhum'}")
        st.write(f"Conversas: {len(st.session_state.conversations)}")

# Roteamento de p√°ginas
if st.session_state.current_page == "home":
    show_home_page()
elif st.session_state.current_page == "bots":
    show_bots_list()
elif st.session_state.current_page == "chat":
    show_chat_interface()
elif st.session_state.current_page == "import":
    show_import_page()

# Rodap√©
st.markdown("---")
st.caption("üé≠ CRINGE - Personagens Interativos | Desenvolvido com Streamlit & FastAPI")
