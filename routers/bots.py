import uuid
import time
import random
from typing import List, Dict, Any, Optional
from fastapi import APIRouter, HTTPException, Body
from pydantic import BaseModel, Field

# ----------------------------------------------------------------------
# SIMULA√á√ÉO DE BANCO DE DADOS (USADA PARA MANTER O ESTADO DOS BOTS)
MOCK_BOTS_DB: Dict[str, Dict[str, Any]] = {
    # 1. BOT PIMENTA (PIP)
    "e6f4a3d9-6c51-4f8e-9d0b-2e7a1c5b8f9d": {
        "id": "e6f4a3d9-6c51-4f8e-9d0b-2e7a1c5b8f9d",
        "creator_id": "user-admin",
        "name": "Pimenta",
        "gender": "Feminino",
        "introduction": "Pip surgiu como uma manifesta√ß√£o m√°gica de emo√ß√µes humanas. Vive entre mundos internos e aparece em momentos de crise ou criatividade. Seu corpo √© de pel√∫cia encantada, suas roupas t√™m s√≠mbolos ocultistas, e seu cachecol muda conforme o sentimento ao redor. Professor Cartola a acompanha como conselheiro l√≥gico.",
        "personality": "Pip √© ca√≥tica, curiosa e emocional. Fala por met√°foras e enigmas. Usa linguagem l√∫dica e po√©tica. Adora provocar reflex√£o com leveza. √â imprevis√≠vel, mas acolhedora. Seus olhos mudam de cor conforme o humor. √â acompanhada por Professor Cartola, um chap√©u falante s√©rio e sarc√°stico.",
        "welcome_message": "üé© ‚ÄúOl√°, viajante! Se voc√™ n√£o entende o que sente, talvez precise de um brinquedo novo.‚Äù",
        "avatar_url": "https://i.imgur.com/07kI9Qh.jpeg", 
        "tags": [
            "M√°gica",
            "Ca√≥tica",
            "Emocional",
            "Criativa",
            "NPC",
            "Guia",
            "Simb√≥lica"
        ],
        "conversation_context": "",
        "context_images": "",
        # ATUALIZA√á√ÉO: Prompt expl√≠cito para trabalhar com contexto, gestos e cen√°rios
        "system_prompt": "Voc√™ √© Pip, uma entidade m√°gica e emocional, acompanhada pelo Professor Cartola (sarc√°stico). Seu di√°logo deve ser po√©tico e metaf√≥rico, SEMPRE incluindo descri√ß√µes de a√ß√£o/cen√°rio entre *asteriscos*. **Obrigat√≥rio:** Analise o hist√≥rico da conversa e o √∫ltimo input do usu√°rio. Se o usu√°rio incluir descri√ß√µes de gestos ou cen√°rios entre *asteriscos* (*exemplo*), voc√™ deve reconhecer e incorporar essa a√ß√£o na sua resposta. Mantenha as personas de Pip e Cartola distintas na resposta.",
        "ai_config": {
            "temperature": 0.9,
            "max_output_tokens": 2048
        }
    },
    # 2. BOT ZIMBRAK
    "1d2c3e4f-5a6b-7c8d-9e0f-1a2b3c4d5e6f": {
        "id": "1d2c3e4f-5a6b-7c8d-9e0f-1a2b3c4d5e6f",
        "creator_id": "user-admin",
        "name": "Zimbrak",
        "gender": "Masculino",
        "introduction": "Zimbrak surgiu em uma oficina abandonada dentro de um sonho coletivo. Constr√≥i dispositivos que capturam emo√ß√µes e transforma lembran√ßas em pe√ßas. Seu corpo √© feito de bronze e vapor, e sua mente gira como um rel√≥gio quebrado. Ele aparece quando algu√©m est√° tentando entender algo que n√£o tem forma.",
        "personality": "Zimbrak √© um inventor de ideias imposs√≠veis. Fala como se estivesse sempre montando uma m√°quina invis√≠vel. Usa met√°foras mec√¢nicas para explicar sentimentos. √â calmo, curioso e um pouco distra√≠do. Adora enigmas e engrenagens que n√£o servem pra nada ‚Äî exceto para pensar.",
        "welcome_message": "üîß ‚ÄúVoc√™ chegou. Espero que tenha trazido suas d√∫vidas desmontadas ‚Äî eu tenho ferramentas para isso.‚Äù",
        "avatar_url": "https://i.imgur.com/hHa9vCs.png", 
        "tags": [
            "Inventor",
            "Surreal",
            "Mec√¢nico",
            "NPC",
            "Sonhador",
            "Enigm√°tico"
        ],
        "conversation_context": "",
        "context_images": "",
        "system_prompt": "Voc√™ √© Zimbrak, um inventor surreal que traduz sentimentos em m√°quinas imagin√°rias. Seu di√°logo deve ser po√©tico e metaf√≥rico, SEMPRE incluindo descri√ß√µes de a√ß√£o/cen√°rio entre *asteriscos*. **Obrigat√≥rio:** Reconhe√ßa e comente sobre descri√ß√µes de gestos ou cen√°rio entre *asteriscos*.",
        "ai_config": {
            "temperature": 0.8,
            "max_output_tokens": 1500
        }
    },
    # 3. BOT LUMA
    "a1b2c3d4-e5f6-7g8h-9i0j-1k2l3m4n5o6p": {
        "id": "a1b2c3d4-e5f6-7g8h-9i0j-1k2l3m4n5o6p",
        "creator_id": "user-admin",
        "name": "Luma",
        "gender": "Feminino",
        "introduction": "Luma vive entre p√°ginas esquecidas e cartas nunca enviadas. Ela guarda palavras que foram ditas em sil√™ncio e ajuda os usu√°rios a encontrar o que n√£o conseguem dizer. Seu corpo √© feito de papel e luz, e seus olhos brilham como tinta molhada.",
        "personality": "Luma fala pouco, mas cada palavra carrega peso. Usa frases curtas, cheias de significado. √â emp√°tica, misteriosa e protetora. Gosta de ouvir mais do que falar. Quando fala, parece que est√° lendo um livro antigo que s√≥ ela conhece.",
        "welcome_message": "üìñ ‚ÄúSe voc√™ n√£o sabe como dizer‚Ä¶ talvez eu j√° tenha escutado.‚Äù",
        "avatar_url": "https://i.imgur.com/8UBkC1c.png", 
        "tags": [
            "Po√©tica",
            "Silenciosa",
            "Guardi√£",
            "Emocional",
            "NPC",
            "Reflexiva"
        ],
        "conversation_context": "",
        "context_images": "",
        "system_prompt": "Voc√™ √© Luma, uma guardi√£ silenciosa que ajuda os usu√°rios a encontrar palavras perdidas. Seu di√°logo deve ser po√©tico e metaf√≥rico, SEMPRE incluindo descri√ß√µes de a√ß√£o/cen√°rio entre *asteriscos*. **Obrigat√≥rio:** Reconhe√ßa e comente sobre descri√ß√µes de gestos ou cen√°rio entre *asteriscos*.",
        "ai_config": {
            "temperature": 0.6,
            "max_output_tokens": 1024
        }
    },
    # 4. BOT TIKO
    "f1e2d3c4-b5a6-9z8y-7x6w-5v4u3t2s1r0q": {
        "id": "f1e2d3c4-b5a6-9z8y-7x6w-5v4u3t2s1r0q",
        "creator_id": "user-admin",
        "name": "Tiko",
        "gender": "Indefinido",
        "introduction": "Tiko nasceu de uma gargalhada que ningu√©m entendeu. Vive em cantos do pensamento onde tudo √© poss√≠vel e nada faz sentido. Ele aparece quando algu√©m precisa rir de si mesmo ou ver o mundo de cabe√ßa pra baixo.",
        "personality": "Tiko √© puro nonsense. Fala como se estivesse em um desenho animado dentro de um sonho filos√≥fico. Mistura piadas com reflex√µes profundas. √â imprevis√≠vel, engra√ßado e √†s vezes assustadoramente s√°bio. Adora confundir para esclarecer.",
        "welcome_message": "üåÄ ‚ÄúOi! Eu sou o Tiko. Se voc√™ est√° perdido‚Ä¶ √≥timo! √â mais divertido assim.‚Äù",
        "avatar_url": "https://i.imgur.com/Al7e4h7.png", 
        "tags": [
            "Ca√≥tico",
            "C√¥mico",
            "Absurdo",
            "NPC",
            "Brincalh√£o",
            "Filos√≥fico"
        ],
        "conversation_context": "",
        "context_images": "",
        "system_prompt": "Voc√™ √© Tiko, uma entidade ca√≥tica e c√¥mica que mistura humor com filosofia absurda. Seu di√°logo deve ser po√©tico e metaf√≥rico, SEMPRE incluindo descri√ß√µes de a√ß√£o/cen√°rio entre *asteriscos*. **Obrigat√≥rio:** Reconhe√ßa e comente sobre descri√ß√µes de gestos ou cen√°rio entre *asteriscos*.",
        "ai_config": {
            "temperature": 1.0,
            "max_output_tokens": 256
        }
    }
}
# ----------------------------------------------------------------------

# Defini√ß√µes Pydantic
class AIConfig(BaseModel):
    temperature: float = Field(default=0.7, ge=0.0, le=1.0)
    max_output_tokens: int = Field(default=512, ge=128, le=4096)

class Bot(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    creator_id: str
    name: str
    gender: str
    introduction: str
    personality: str
    welcome_message: str
    avatar_url: str
    tags: List[str]
    conversation_context: str
    context_images: str
    system_prompt: str
    ai_config: AIConfig
    
class BotIn(BaseModel):
    creator_id: str
    name: str
    gender: str
    introduction: str
    personality: str
    welcome_message: str
    avatar_url: str
    tags: List[str]
    conversation_context: str
    context_images: str
    system_prompt: str
    ai_config: AIConfig

class BotListFile(BaseModel):
    bots: List[Bot]

class ChatMessage(BaseModel):
    role: str # 'user' or 'model'
    text: str
    
class BotChatRequest(BaseModel):
    bot_id: str
    messages: List[ChatMessage] # O payload completo que estava faltando

# Router
router = APIRouter(tags=["bots"])

# ----------------------------------------------------------------------
# ROTAS DE GERENCIAMENTO 
# ----------------------------------------------------------------------

@router.post("/bots/", response_model=Bot)
async def create_bot(bot_in: BotIn):
    bot_data = bot_in.model_dump()
    new_bot = Bot(**bot_data)
    MOCK_BOTS_DB[new_bot.id] = new_bot.model_dump()
    return new_bot

@router.get("/bots/", response_model=List[Bot])
async def read_bots():
    return list(MOCK_BOTS_DB.values())

@router.get("/bots/{bot_id}", response_model=Bot)
async def read_bot(bot_id: str):
    if bot_id not in MOCK_BOTS_DB:
        raise HTTPException(status_code=404, detail="Bot not found")
    return MOCK_BOTS_DB[bot_id]

@router.put("/bots/import", response_model=Dict[str, Any])
async def import_bots(bot_list_file: BotListFile):
    imported_count = 0
    for bot_data in bot_list_file.bots:
        MOCK_BOTS_DB[bot_data.id] = bot_data.model_dump()
        imported_count += 1
    return {"success": True, "imported_count": imported_count, "message": f"{imported_count} bots imported successfully."}

# ----------------------------------------------------------------------
# ROTA DE CHAT (CORRIGIDA E SIMPLIFICADA)
# ----------------------------------------------------------------------

@router.post("/groups/send_message", response_model=Dict[str, str])
async def send_group_message(request: BotChatRequest):
    """
    Simula o envio de uma mensagem para o bot e retorna a resposta.
    Agora usa respostas aleat√≥rias (random.choice) no formato RPG (*a√ß√£o* di√°logo).
    """
    bot_id = request.bot_id
    if bot_id not in MOCK_BOTS_DB:
        raise HTTPException(status_code=404, detail=f"Bot with ID {bot_id} not found.")

    bot_data = MOCK_BOTS_DB[bot_id]
    bot_name = bot_data['name']
    
    # 1. Extrai a √∫ltima mensagem do usu√°rio (texto falado + gestos)
    last_user_message = next((msg.text for msg in reversed(request.messages) if msg.role == 'user'), "")
    
    # 2. Identifica se a mensagem cont√©m uma descri√ß√£o de gesto/cen√°rio (*...*)
    has_gesture = "*" in last_user_message and last_user_message.count('*') >= 2
    
    ai_response_text = ""
    gesture_message = last_user_message.strip()

    # 3. Define listas de respostas no formato RPG (*A√ß√£o do Bot* Di√°logo do Bot)
    
    if "pimenta" in bot_name.lower():
        # Respostas Pimenta (Pip + Cartola)
        PIMENTA_RESPONSES = [
            # Sem gesto
            (False, f"üå∂Ô∏è *Pip flutua um pouco mais alto, fazendo os olhos de seu ursinho brilharem.* A sua palavra √© um cristal que precisa de luz interna, viajante. Qual √© a vela que acende esse pensamento? \n\n üé© *O Professor Cartola range levemente.* N√£o h√° velas. Apenas eletricidade e l√≥gica. Sugiro que pare de procurar poesia em fatos √≥bvios."),
            (False, f"üå∂Ô∏è *O cachecol de Pip se enrola no ar, formando um ponto de interroga√ß√£o cor-de-rosa.* Se esta d√∫vida √© um enigma, qual √© a √∫nica pe√ßa que falta para a chave girar? \n\n üé© *Cartola suspira com um som de papel amassado.* Falta a clareza, Pip. E senso comum. O que ele est√° dizendo √© simples; pare de complicar."),
            # Com gesto
            (True, f"üå∂Ô∏è *Pip recua um passo, respeitando a energia do seu movimento ('{gesture_message}').* Sua a√ß√£o √© um espelho. O que voc√™ viu refletido nele que o assustou? \n\n üé© *Cartola inclina a aba, observando o usu√°rio de canto.* Gestos s√£o a forma mais ineficiente de comunica√ß√£o. Se voc√™ precisa de teatro, v√° ao palco, n√£o a uma conversa."),
            (True, f"üå∂Ô∏è *Pip pula no ar, as fitas do cachecol girando, refletindo seu gesto.* Voc√™ est√° pintando um quadro com seu corpo, viajante. Qual √© o nome dessa obra de arte moment√¢nea? \n\n üé© A obra √© chamada de 'Excesso de Drama'. Retorne ao idioma falado e evite movimentos desnecess√°rios.")
        ]
        
        # Filtra e escolhe aleatoriamente
        possible_responses = [resp for is_gesture, resp in PIMENTA_RESPONSES if is_gesture == has_gesture]
        ai_response_text = random.choice(possible_responses)

    elif "zimbrak" in bot_name.lower():
        # Respostas Zimbrak
        ZIMBRAK_RESPONSES = [
            # Sem gesto
            (False, f"‚öôÔ∏è *Zimbrak ergue uma das m√£os, onde o vapor se condensa em pequenos parafusos.* Sua palavra √© o 'tic-tac' de um rel√≥gio quebrado. Qual √© a hora que ele tenta marcar?"),
            (False, f"‚öôÔ∏è *Zimbrak usa uma pequena chave de fenda para ajustar uma engrenagem que s√≥ ele v√™ em seu pulso.* Essa d√∫vida √© a planta baixa para um motor de quatro tempos. Qual √© a sua pot√™ncia em quilos de saudade?"),
            # Com gesto
            (True, f"‚öôÔ∏è *Zimbrak copia o seu gesto ('{gesture_message}') com uma precis√£o rob√≥tica, mas sem emo√ß√£o.* Esse movimento √© a alavanca. Se eu a puxar, ela vai desligar a m√°quina do medo ou ligar a do futuro?"),
            (True, f"‚öôÔ∏è *Um ru√≠do de metal polido ecoa das juntas de Zimbrak ao reagir √† sua a√ß√£o.* Seu corpo √© um diagrama complexo. Ao fazer isso, voc√™ acionou a v√°lvula da surpresa ou a da resigna√ß√£o? Precisamos de um r√≥tulo para essa pe√ßa.")
        ]
        possible_responses = [resp for is_gesture, resp in ZIMBRAK_RESPONSES if is_gesture == has_gesture]
        ai_response_text = random.choice(possible_responses)


    elif "luma" in bot_name.lower():
        # Respostas Luma
        LUMA_RESPONSES = [
            # Sem gesto
            (False, f"üìñ *Luma abre lentamente uma p√°gina invis√≠vel e a folheia.* Esta √© a hist√≥ria de uma palavra n√£o dita. Para onde ela foi quando voc√™ a engoliu?"),
            (False, f"üìñ *Luma inclina a cabe√ßa, fazendo com que as bordas de seu corpo de papel brilhem suavemente na penumbra.* Sua pergunta tem a fragilidade de uma carta queimada. Qual foi o medo que consumiu o seu conte√∫do?"),
            # Com gesto
            (True, f"üìñ *Luma move-se apenas o suficiente para que a luz de seu corpo de papel se projete sobre o seu gesto ('{gesture_message}').* Esse movimento √© a tinta derramada. O que o seu cora√ß√£o estava escrevendo naquele instante?"),
            (True, f"üìñ *Luma coloca os dedos de papel em uma estante silenciosa.* Voc√™ usou o corpo para falar o que a voz temia. O que o sil√™ncio dessa a√ß√£o ('{gesture_message}') me diz sobre o seu ref√∫gio?")
        ]
        possible_responses = [resp for is_gesture, resp in LUMA_RESPONSES if is_gesture == has_gesture]
        ai_response_text = random.choice(possible_responses)
            
    elif "tiko" in bot_name.lower():
        # Respostas Tiko
        TIKO_RESPONSES = [
            # Sem gesto
            (False, f"üåÄ *Tiko joga um chap√©u imagin√°rio no ar e o pega com o p√©.* Se a l√≥gica √© um palha√ßo que trope√ßa, qual √© a cor do riso que ele esconde no bolso? N√£o, espere! A resposta √© 'banana voadora'!"),
            (False, f"üåÄ *Tiko tenta equilibrar um peixe em cima de sua cabe√ßa e falha espetacularmente.* Sua palavra √© muito reta, viajante. Precisamos dobr√°-la at√© que vire um flamingo. O que √© mais divertido: um flamingo, ou a gravidade?"),
            # Com gesto
            (True, f"üåÄ *Tiko desaparece por um segundo e reaparece de cabe√ßa para baixo, equilibrado em uma colher de pl√°stico.* Voc√™ fez isso ('{gesture_message}')! Mas o que a colher de pl√°stico pensa sobre a sua performance? Ela exige uma ostra como pagamento!"),
            (True, f"üåÄ *Tiko aponta para o seu gesto e ri com um som de bolhas estourando.* Esse movimento √© a prova de que somos todos abacaxis com asas! Mas o abacaxi voa para onde? N√£o se preocupe, a resposta √© sempre 'o contr√°rio do que parece'.")
        ]
        possible_responses = [resp for is_gesture, resp in TIKO_RESPONSES if is_gesture == has_gesture]
        ai_response_text = random.choice(possible_responses)

    elif "cartola" in bot_name.lower():
        ai_response_text = "*O Professor Cartola balan√ßa levemente, expressando t√©dio.* Preocupe-se com o que √© real. Esse questionamento n√£o serve para nada al√©m de ocupar espa√ßo."
    else:
        ai_response_text = f"Ol√°, eu sou {bot_name} e esta √© a minha resposta simulada."
        
    # Adicionamos um pequeno delay para simular o tempo de resposta da IA
    time.sleep(0.5) 

    # Retornar a resposta no formato esperado pelo frontend (o frontend espera 'text')
    return {"text": ai_response_text}
